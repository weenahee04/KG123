// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SYSTEM CONFIGURATION (Singleton)
// ============================================
model SystemConfig {
  id              String   @id @default("config")
  initialCapital  Decimal  @default(500000) @db.Decimal(15, 2)
  
  // Base Payout Rates
  payoutTop3      Int      @default(800)
  payoutToad3     Int      @default(150)
  payoutTop2      Int      @default(90)
  payoutBottom2   Int      @default(90)
  payoutRun       Decimal  @default(3.2) @db.Decimal(5, 2)
  
  // Tier 1 Payout Rates (70-85% usage)
  payoutTop3Tier1      Int      @default(650)
  payoutToad3Tier1     Int      @default(130)
  payoutTop2Tier1      Int      @default(80)
  payoutBottom2Tier1   Int      @default(80)
  payoutRunTier1       Decimal  @default(3.0) @db.Decimal(5, 2)
  
  // Tier 2 Payout Rates (85-100% usage)
  payoutTop3Tier2      Int      @default(500)
  payoutToad3Tier2     Int      @default(110)
  payoutTop2Tier2      Int      @default(70)
  payoutBottom2Tier2   Int      @default(70)
  payoutRunTier2       Decimal  @default(2.8) @db.Decimal(5, 2)
  
  // Affiliate/Commission Rate
  affiliateRate   Decimal  @default(0.08) @db.Decimal(5, 4)
  
  // Risk Thresholds
  warningThreshold  Decimal  @default(0.70) @db.Decimal(5, 4)
  dangerThreshold   Decimal  @default(0.85) @db.Decimal(5, 4)
  rejectThreshold   Decimal  @default(1.00) @db.Decimal(5, 4)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// GLOBAL STATISTICS (Singleton)
// ============================================
model GlobalStats {
  id              String   @id @default("stats")
  netTotalSales   Decimal  @default(0) @db.Decimal(15, 2)
  totalTickets    Int      @default(0)
  totalWinnings   Decimal  @default(0) @db.Decimal(15, 2)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// LOTTERY RISK TRACKING (Per Number)
// ============================================
model LottoRisk {
  id              String   @id @default(cuid())
  type            String   // "TOP3", "TOAD3", "TOP2", "BOTTOM2", "RUN"
  number          String   // "123", "45", "7"
  totalBetAmount  Decimal  @default(0) @db.Decimal(15, 2)
  betCount        Int      @default(0)
  isBlocked       Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([type, number])
  @@index([type])
  @@index([totalBetAmount])
}

// ============================================
// LOTTERY ROUND
// ============================================
model LotteryRound {
  id              String   @id @default(cuid())
  roundNumber     String   @unique
  lotteryType     String   // "GOVERNMENT", "YIKI", "HANOI", "LAOS", "STOCK"
  drawDate        DateTime
  openTime        DateTime
  closeTime       DateTime
  status          String   @default("WAITING") // "WAITING", "OPEN", "CLOSED", "ANNOUNCED", "PAID"
  
  // Results
  resultTop3      String?
  resultToad3     String?
  resultTop2      String?
  resultBottom2   String?
  resultRun       String?
  
  tickets         Ticket[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([drawDate])
}

// ============================================
// USER/MEMBER
// ============================================
model User {
  id              String   @id @default(cuid())
  username        String   @unique
  email           String?  @unique
  password        String
  fullName        String?
  phoneNumber     String?
  
  role            String   @default("MEMBER") // "MEMBER", "AGENT", "ADMIN", "SUPER_ADMIN"
  status          String   @default("ACTIVE") // "ACTIVE", "SUSPENDED", "BANNED"
  
  balance         Decimal  @default(0) @db.Decimal(15, 2)
  
  // Referral System
  referralCode    String?  @unique
  referredBy      String?
  referrer        User?    @relation("Referrals", fields: [referredBy], references: [id])
  referrals       User[]   @relation("Referrals")
  
  tickets         Ticket[]
  transactions    Transaction[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([username])
  @@index([referralCode])
}

// ============================================
// TICKET (Bet)
// ============================================
model Ticket {
  id              String   @id @default(cuid())
  ticketNumber    String   @unique
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  roundId         String
  round           LotteryRound @relation(fields: [roundId], references: [id])
  
  bets            Bet[]
  
  totalAmount     Decimal  @db.Decimal(15, 2)
  netAmount       Decimal  @db.Decimal(15, 2) // After affiliate commission
  
  status          String   @default("PENDING") // "PENDING", "WON", "LOST", "CANCELLED"
  
  hasReferrer     Boolean  @default(false)
  commissionPaid  Decimal  @default(0) @db.Decimal(15, 2)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([roundId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// BET (Individual Number Bet)
// ============================================
model Bet {
  id              String   @id @default(cuid())
  
  ticketId        String
  ticket          Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  type            String   // "TOP3", "TOAD3", "TOP2", "BOTTOM2", "RUN"
  number          String   // "123", "45", "7"
  amount          Decimal  @db.Decimal(15, 2)
  
  assignedPayout  Decimal  @db.Decimal(10, 2) // The payout rate assigned at bet time
  potentialWin    Decimal  @db.Decimal(15, 2) // amount * assignedPayout
  
  status          String   @default("PENDING") // "PENDING", "WON", "LOST"
  actualWin       Decimal  @default(0) @db.Decimal(15, 2)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([ticketId])
  @@index([type, number])
}

// ============================================
// TRANSACTION (Deposit/Withdrawal)
// ============================================
model Transaction {
  id              String   @id @default(cuid())
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  type            String   // "DEPOSIT", "WITHDRAWAL", "BET", "WIN", "COMMISSION"
  amount          Decimal  @db.Decimal(15, 2)
  balanceBefore   Decimal  @db.Decimal(15, 2)
  balanceAfter    Decimal  @db.Decimal(15, 2)
  
  status          String   @default("PENDING") // "PENDING", "APPROVED", "REJECTED", "COMPLETED"
  
  reference       String?  // Bank transaction reference, ticket number, etc.
  note            String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}
